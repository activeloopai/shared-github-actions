name: Deep Lake full tests

on:
  workflow_call:
    inputs:
      repo:
        required: true
        type: string
      ref:
        required: true
        type: string
    secrets:
      token:
        required: true
      aws_role_arn:
        required: true
      gcp_sa_credentials_json:
        required: true
      oauth_client_id:
        required: true
      oauth_client_secret:
        required: true
      oauth_refresh_token:
        required: true
      hub_token:
        required: true
      hub_username:
        required: true
      kaggle_username:
        required: true
      kaggle_key:
        required: true
      azure_creds_json:
        required: true
      sonar_token:
        required: false

jobs:
  buh-test:
    name: Backwards Compatibility Test
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      BUGGER_OFF: "true"

    steps:
      - uses: actions/checkout@v3
        with:
          repository: ${{ inputs.repo }}
          ref: ${{ inputs.ref }}
          token: ${{ secrets.token }}
          fetch-depth: 0

      - name: Checkout the buH source code
        uses: actions/checkout@v3
        with:
          path: buH
          repository: activeloopai/buH
          token: ${{ secrets.token }}
          fetch-depth: 0

      # This will slowly get behind as new versions are released that are not in the cache. The cache can be dropped through the github UI when creation takes too long
      - name: Cache datasets_clean
        uses: actions/cache@v3
        with:
          path: datasets_clean/*
          key: buH-datasets-clean

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: deeplake/requirements/*.txt

      - name: Install Libraries
        run: |
          pip3 install --upgrade pip --user
          pip3 install --upgrade setuptools
          pip3 install -r deeplake/requirements/common.txt
          pip3 install -r deeplake/requirements/tests.txt
          pip3 install -e .[all]
          pip3 install -e buH

      - name: Create Datasets
        run: buH/buh/scripts/create_all.sh

      - name: Cleanup Libraries
        run: pip3 install --upgrade --force-reinstall -e .

      - name: Run backwards compatibility tests
        run:  python3 -m pytest --junitxml=buh.results.xml --capture=sys -o junit_logging=all buH/
        env:
          ACTIVELOOP_HUB_USERNAME: ${{ secrets.hub_username }}
          ACTIVELOOP_HUB_TOKEN: ${{ secrets.hub_token }}
          KAGGLE_USERNAME: ${{ secrets.kaggle_username }}
          KAGGLE_KEY: ${{ secrets.kaggle_key }}
